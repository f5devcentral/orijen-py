from tenacity import retry, stop_after_attempt, wait_exponential
from requests.exceptions import HTTPError
import requests

def retry_if_http_error(exception):
    return isinstance(exception, HTTPError) and exception.response.status_code in [429, 503]

retry_config = {
    'stop': stop_after_attempt(3),
    'wait': wait_exponential(multiplier=1, min=1, max=10),
    'retry': retry_if_http_error
}

class XCSession:
    def __init__(self, tenant_url, api_token):
        self.tenant_url = tenant_url.rstrip('/')
        self.api_token = api_token
        self.session = requests.Session()
        self.session.headers.update({'Authorization': f'APIToken {self.api_token}'})

    @retry(**retry_config)
    def get(self, path, params=None, **kwargs):
        url = f'{self.tenant_url}/{path.lstrip("/")}'
        response = self.session.get(url, params=params, **kwargs)
        response.raise_for_status()
        return response.json()

    @retry(**retry_config)
    def post(self, path, json=None, **kwargs):
        url = f'{self.tenant_url}/{path.lstrip("/")}'
        response = self.session.post(url, json=json, **kwargs)
        response.raise_for_status()
        return response.json()

    @retry(**retry_config)
    def put(self, path, json=None, **kwargs):
        url = f'{self.tenant_url}/{path.lstrip("/")}'
        response = self.session.put(url, json=json, **kwargs)
        response.raise_for_status()
        return response.json()

    @retry(**retry_config)
    def delete(self, path, **kwargs):
        url = f'{self.tenant_url}/{path.lstrip("/")}'
        response = self.session.delete(url, **kwargs)
        response.raise_for_status()
        return response.json()
